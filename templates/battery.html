<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battery Monitoring Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #1a1a2e;
            color: #eee;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .cell-card {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            border: 1px solid #4a5568;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .cell-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        .cell-header {
            font-size: 1.1rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }
        .voltage-display {
            font-size: 2.5rem;
            font-weight: bold;
            color: #48bb78;
            text-align: center;
            margin: 10px 0;
        }
        .temp-display {
            font-size: 1.5rem;
            color: #f6ad55;
        }
        .capacity-bar {
            height: 25px;
            background: #2d3748;
            border-radius: 12px;
            overflow: hidden;
            margin: 10px 0;
        }
        .capacity-fill {
            height: 100%;
            background: linear-gradient(90deg, #48bb78 0%, #38a169 100%);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #4a5568;
        }
        .stat-label {
            color: #a0aec0;
        }
        .stat-value {
            color: #edf2f7;
            font-weight: bold;
        }
        .bank-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: center;
        }
        .summary-card {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .summary-stat {
            text-align: center;
            padding: 15px;
        }
        .summary-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }
        .summary-label {
            color: #a0aec0;
            font-size: 0.9rem;
        }
        .status-badge {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85rem;
            font-weight: bold;
        }
        .status-good { background-color: #48bb78; color: white; }
        .status-warning { background-color: #f6ad55; color: white; }
        .status-danger { background-color: #f56565; color: white; }
        .no-data {
            text-align: center;
            padding: 40px;
            color: #a0aec0;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-battery-three-quarters"></i> Battery Monitor
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/battery">Battery</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/charts">Charts</a>
                    </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <span class="nav-link">
                            <i class="fas fa-clock"></i>
                            <span id="lastUpdate">Loading...</span>
                        </span>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <!-- Summary Section -->
        <div id="summarySection" class="summary-card" style="display: none;">
            <div class="row">
                <div class="col-md-3">
                    <div class="summary-stat">
                        <div class="summary-value" id="totalCells">0</div>
                        <div class="summary-label">Total Cells</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="summary-stat">
                        <div class="summary-value" id="avgVoltage">0.00V</div>
                        <div class="summary-label">Avg Voltage</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="summary-stat">
                        <div class="summary-value" id="avgTemp">0°C</div>
                        <div class="summary-label">Avg Temperature</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="summary-stat">
                        <div class="summary-value" id="totalCapacity">0Ah</div>
                        <div class="summary-label">Total Capacity</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Battery Banks Container -->
        <div id="batteryContainer">
            <div class="no-data">
                <i class="fas fa-battery-empty fa-3x mb-3"></i>
                <p>Waiting for battery data...</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let batteryData = {};

        function updateBatteryDisplay() {
            fetch('/api/battery')
                .then(response => response.json())
                .then(data => {
                    batteryData = data;
                    renderBatteries();
                    updateLastUpdate();
                })
                .catch(error => {
                    console.error('Error fetching battery data:', error);
                });
        }

        function renderBatteries() {
            const container = document.getElementById('batteryContainer');

            if (Object.keys(batteryData).length === 0) {
                container.innerHTML = '<div class="no-data"><i class="fas fa-battery-empty fa-3x mb-3"></i><p>No battery data available</p></div>';
                document.getElementById('summarySection').style.display = 'none';
                return;
            }

            document.getElementById('summarySection').style.display = 'block';

            let html = '';
            let totalCells = 0;
            let totalVoltage = 0;
            let totalTemp = 0;
            let totalCapacity = 0;

            // Render each bank
            for (const [bankId, cells] of Object.entries(batteryData).sort()) {
                html += `<div class="bank-header"><h3><i class="fas fa-layer-group"></i> Battery Bank ${bankId}</h3></div>`;
                html += '<div class="row">';

                // Render each cell
                for (const [cellId, cell] of Object.entries(cells).sort((a, b) => parseInt(a[0]) - parseInt(b[0]))) {
                    totalCells++;
                    totalVoltage += cell.voltage;
                    totalTemp += cell.inttemp;
                    totalCapacity += cell.mAh / 1000; // Convert to Ah

                    const voltageStatus = getVoltageStatus(cell.voltage);
                    const tempStatus = getTempStatus(cell.inttemp);
                    const capacityPercent = (cell.mAh / 60000 * 100).toFixed(1); // Assuming 60Ah cells

                    html += `
                    <div class="col-md-6 col-lg-4 col-xl-3">
                        <div class="cell-card">
                            <div class="cell-header">
                                <i class="fas fa-battery-half"></i> Cell ${cellId}
                                <span class="status-badge status-${voltageStatus}" style="float: right;">${voltageStatus.toUpperCase()}</span>
                            </div>

                            <div class="voltage-display">${cell.voltage.toFixed(3)}V</div>

                            <div class="stat-row">
                                <span class="stat-label"><i class="fas fa-arrow-up"></i> Max:</span>
                                <span class="stat-value">${cell.vMax.toFixed(3)}V</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label"><i class="fas fa-arrow-down"></i> Min:</span>
                                <span class="stat-value">${cell.vMin.toFixed(3)}V</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label"><i class="fas fa-thermometer-half"></i> Temp:</span>
                                <span class="stat-value status-badge status-${tempStatus}">${cell.inttemp}°C</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label"><i class="fas fa-bolt"></i> Capacity:</span>
                                <span class="stat-value">${(cell.mAh / 1000).toFixed(1)}Ah</span>
                            </div>

                            <div class="capacity-bar">
                                <div class="capacity-fill" style="width: ${capacityPercent}%">${capacityPercent}%</div>
                            </div>

                            ${cell.bypass === 1 ? '<div class="text-center mt-2"><span class="status-badge status-warning"><i class="fas fa-exclamation-triangle"></i> BYPASS ACTIVE</span></div>' : ''}
                        </div>
                    </div>
                    `;
                }

                html += '</div>';
            }

            container.innerHTML = html;

            // Update summary
            document.getElementById('totalCells').textContent = totalCells;
            document.getElementById('avgVoltage').textContent = (totalVoltage / totalCells).toFixed(3) + 'V';
            document.getElementById('avgTemp').textContent = Math.round(totalTemp / totalCells) + '°C';
            document.getElementById('totalCapacity').textContent = totalCapacity.toFixed(1) + 'Ah';
        }

        function getVoltageStatus(voltage) {
            // LiFePO4 typical ranges: 3.0-3.65V per cell
            if (voltage >= 3.3 && voltage <= 3.65) return 'good';
            if (voltage >= 3.0 && voltage < 3.3) return 'warning';
            return 'danger';
        }

        function getTempStatus(temp) {
            if (temp >= 15 && temp <= 35) return 'good';
            if (temp >= 5 && temp < 45) return 'warning';
            return 'danger';
        }

        function updateLastUpdate() {
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        // Auto-refresh every 5 seconds
        setInterval(updateBatteryDisplay, 5000);

        // Initial load
        updateBatteryDisplay();
    </script>
</body>
</html>
