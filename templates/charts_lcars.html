<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MPP-Solar LCARS - Historical Data</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        :root {
            --lcars-orange: #FF9C00;
            --lcars-red: #CC6666;
            --lcars-purple: #CC99CC;
            --lcars-blue: #9999CC;
            --lcars-yellow: #FFFF99;
            --lcars-dark: #1A1A1A;
            --lcars-darker: #0D0D0D;
            --lcars-text: #FFFFFF;
            --lcars-text-dim: #CCCCCC;
        }

        body {
            background: linear-gradient(135deg, var(--lcars-darker) 0%, var(--lcars-dark) 100%);
            color: var(--lcars-text);
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        .lcars-header {
            background: linear-gradient(90deg, var(--lcars-orange) 0%, var(--lcars-red) 50%, var(--lcars-purple) 100%);
            padding: 20px 0;
            position: relative;
            overflow: hidden;
        }

        .lcars-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(255, 255, 255, 0.1) 10px,
                rgba(255, 255, 255, 0.1) 20px
            );
        }

        .lcars-header h1 {
            color: var(--lcars-text);
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            margin: 0;
            position: relative;
            z-index: 1;
        }

        .lcars-nav-btn {
            background: var(--lcars-orange);
            color: var(--lcars-text);
            border: none;
            border-radius: 20px 0 0 20px;
            padding: 10px 20px;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .lcars-nav-btn:hover {
            background: var(--lcars-red);
            color: var(--lcars-text);
            transform: translateX(5px);
        }

        .lcars-nav-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .lcars-nav-btn:hover::before {
            left: 100%;
        }

        .lcars-control-panel {
            background: var(--lcars-dark);
            border: 2px solid var(--lcars-orange);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
        }

        .lcars-control-panel::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, var(--lcars-orange), var(--lcars-red), var(--lcars-purple));
            border-radius: 15px;
            z-index: -1;
            opacity: 0.3;
        }

        .lcars-select {
            background: var(--lcars-dark);
            color: var(--lcars-text);
            border: 2px solid var(--lcars-orange);
            border-radius: 10px;
            padding: 10px 15px;
            font-weight: bold;
        }

        .lcars-select:focus {
            background: var(--lcars-dark);
            color: var(--lcars-text);
            border-color: var(--lcars-red);
            box-shadow: 0 0 10px var(--lcars-orange);
        }

        .lcars-btn {
            background: linear-gradient(45deg, var(--lcars-orange), var(--lcars-red));
            color: var(--lcars-text);
            border: none;
            border-radius: 10px;
            padding: 12px 25px;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .lcars-btn:hover {
            background: linear-gradient(45deg, var(--lcars-red), var(--lcars-purple));
            color: var(--lcars-text);
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(255, 156, 0, 0.4);
        }

        .lcars-tabs {
            background: var(--lcars-dark);
            border: 2px solid var(--lcars-orange);
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .lcars-tab-nav {
            background: linear-gradient(90deg, var(--lcars-orange), var(--lcars-red));
            padding: 0;
            margin: 0;
            list-style: none;
            display: flex;
            flex-wrap: wrap;
        }

        .lcars-tab-nav li {
            flex: 1;
            min-width: 120px;
        }

        .lcars-tab-btn {
            background: transparent;
            color: var(--lcars-text);
            border: none;
            padding: 15px 20px;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.3s ease;
            position: relative;
            width: 100%;
        }

        .lcars-tab-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--lcars-text);
        }

        .lcars-tab-btn.active {
            background: var(--lcars-dark);
            color: var(--lcars-orange);
            box-shadow: inset 0 0 10px rgba(255, 156, 0, 0.3);
        }

        .lcars-tab-btn[aria-selected="true"] {
            background: var(--lcars-dark);
            color: var(--lcars-orange);
            box-shadow: inset 0 0 10px rgba(255, 156, 0, 0.3);
        }

        .lcars-tab-content {
            background: var(--lcars-dark);
            padding: 20px;
            min-height: 500px;
        }

        .lcars-chart-container {
            background: var(--lcars-darker);
            border: 2px solid var(--lcars-blue);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
        }

        .lcars-chart-container::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, var(--lcars-blue), var(--lcars-purple));
            border-radius: 15px;
            z-index: -1;
            opacity: 0.2;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        .lcars-metric-card {
            background: linear-gradient(135deg, var(--lcars-orange) 0%, var(--lcars-red) 100%);
            color: var(--lcars-text);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            position: relative;
            overflow: hidden;
        }

        .lcars-metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 5px,
                rgba(255, 255, 255, 0.1) 5px,
                rgba(255, 255, 255, 0.1) 10px
            );
        }

        .lcars-metric-card h6 {
            color: var(--lcars-text);
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
        }

        .lcars-metric-card small {
            color: var(--lcars-text);
            font-weight: bold;
            position: relative;
            z-index: 1;
        }

        .lcars-status {
            color: var(--lcars-yellow);
            font-weight: bold;
            text-transform: uppercase;
        }

        .lcars-loading {
            text-align: center;
            padding: 40px;
            color: var(--lcars-orange);
            font-weight: bold;
            text-transform: uppercase;
        }

        .lcars-no-data {
            text-align: center;
            padding: 40px;
            color: var(--lcars-text-dim);
            font-style: italic;
            text-transform: uppercase;
        }

        /* LCARS Chart.js Theme */
        .lcars-chart {
            background: var(--lcars-darker) !important;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: var(--lcars-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--lcars-orange);
            border-radius: 6px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--lcars-red);
        }

        /* LCARS corner decorations */
        .lcars-corner {
            position: fixed;
            width: 50px;
            height: 50px;
            border: 3px solid var(--lcars-orange);
            z-index: 1000;
        }

        .lcars-corner-tl {
            top: 0;
            left: 0;
            border-right: none;
            border-bottom: none;
            border-radius: 0 0 20px 0;
        }

        .lcars-corner-tr {
            top: 0;
            right: 0;
            border-left: none;
            border-bottom: none;
            border-radius: 0 0 0 20px;
        }

        .lcars-corner-bl {
            bottom: 0;
            left: 0;
            border-right: none;
            border-top: none;
            border-radius: 0 20px 0 0;
        }

        .lcars-corner-br {
            bottom: 0;
            right: 0;
            border-left: none;
            border-top: none;
            border-radius: 20px 0 0 0;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .lcars-tab-nav {
                flex-direction: column;
            }
            
            .lcars-tab-nav li {
                min-width: auto;
            }
            
            .lcars-header h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- LCARS Corner Decorations -->
    <div class="lcars-corner lcars-corner-tl"></div>
    <div class="lcars-corner lcars-corner-tr"></div>
    <div class="lcars-corner lcars-corner-bl"></div>
    <div class="lcars-corner lcars-corner-br"></div>

    <div class="container-fluid">
        <!-- LCARS Header -->
        <div class="lcars-header">
            <div class="row align-items-center">
                <div class="col">
                    <h1 class="h3 mb-0">
                        <i class="fas fa-chart-line"></i>
                        MPP-SOLAR LCARS INTERFACE
                    </h1>
                    <small class="text-light">Historical Data Analysis System</small>
                </div>
                <div class="col-auto">
                    <a href="/" class="lcars-nav-btn">
                        <i class="fas fa-tachometer-alt"></i> Main Bridge
                    </a>
                </div>
            </div>
        </div>

        <!-- LCARS Control Panel -->
        <div class="lcars-control-panel">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <label for="timeRange" class="form-label lcars-status">Temporal Range:</label>
                    <select class="form-select lcars-select" id="timeRange">
                        <option value="1">Last Hour</option>
                        <option value="6">Last 6 Hours</option>
                        <option value="12">Last 12 Hours</option>
                        <option value="24" selected>Last 24 Hours</option>
                        <option value="48">Last 48 Hours</option>
                        <option value="168">Last Week</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <button class="lcars-btn" id="refreshCharts">
                        <i class="fas fa-sync-alt"></i> Refresh Data
                    </button>
                    <span class="ms-3 lcars-status" id="lastUpdate">Last update: Never</span>
                </div>
            </div>
        </div>

        <!-- LCARS Tabs -->
        <div class="lcars-tabs">
            <ul class="lcars-tab-nav" id="chartTabs" role="tablist">
                <li role="presentation">
                    <button class="lcars-tab-btn active" id="voltage-tab" data-bs-toggle="tab" data-bs-target="#voltage" type="button" role="tab">
                        <i class="fas fa-bolt"></i> Voltage
                    </button>
                </li>
                <li role="presentation">
                    <button class="lcars-tab-btn" id="power-tab" data-bs-toggle="tab" data-bs-target="#power" type="button" role="tab">
                        <i class="fas fa-plug"></i> Power
                    </button>
                </li>
                <li role="presentation">
                    <button class="lcars-tab-btn" id="temperature-tab" data-bs-toggle="tab" data-bs-target="#temperature" type="button" role="tab">
                        <i class="fas fa-thermometer-half"></i> Temperature
                    </button>
                </li>
                <li role="presentation">
                    <button class="lcars-tab-btn" id="current-tab" data-bs-toggle="tab" data-bs-target="#current" type="button" role="tab">
                        <i class="fas fa-tachometer-alt"></i> Current
                    </button>
                </li>
                <li role="presentation">
                    <button class="lcars-tab-btn" id="status-tab" data-bs-toggle="tab" data-bs-target="#status" type="button" role="tab">
                        <i class="fas fa-info-circle"></i> Status
                    </button>
                </li>
            </ul>

            <!-- LCARS Tab Content -->
            <div class="tab-content lcars-tab-content" id="chartTabsContent">
                <!-- Voltage Charts -->
                <div class="tab-pane fade show active" id="voltage" role="tabpanel">
                    <div class="lcars-chart-container">
                        <h5 class="lcars-status mb-3">
                            <i class="fas fa-bolt"></i>
                            Battery & AC Voltage Analysis
                        </h5>
                        <div class="chart-container">
                            <canvas id="voltageChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Power Charts -->
                <div class="tab-pane fade" id="power" role="tabpanel">
                    <div class="lcars-chart-container">
                        <h5 class="lcars-status mb-3">
                            <i class="fas fa-plug"></i>
                            Power Output & Load Analysis
                        </h5>
                        <div class="chart-container">
                            <canvas id="powerChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Temperature Charts -->
                <div class="tab-pane fade" id="temperature" role="tabpanel">
                    <div class="lcars-chart-container">
                        <h5 class="lcars-status mb-3">
                            <i class="fas fa-thermometer-half"></i>
                            Temperature Monitoring
                        </h5>
                        <div class="chart-container">
                            <canvas id="temperatureChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Current Charts -->
                <div class="tab-pane fade" id="current" role="tabpanel">
                    <div class="lcars-chart-container">
                        <h5 class="lcars-status mb-3">
                            <i class="fas fa-tachometer-alt"></i>
                            Current Flow Analysis
                        </h5>
                        <div class="chart-container">
                            <canvas id="currentChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Status Charts -->
                <div class="tab-pane fade" id="status" role="tabpanel">
                    <div class="lcars-chart-container">
                        <h5 class="lcars-status mb-3">
                            <i class="fas fa-info-circle"></i>
                            System Status Overview
                        </h5>
                        <div class="chart-container">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- LCARS Data Summary -->
        <div class="lcars-control-panel">
            <h5 class="lcars-status mb-3">
                <i class="fas fa-table"></i>
                System Performance Summary
            </h5>
            <div id="dataSummary">
                <div class="lcars-loading">
                    <i class="fas fa-spinner fa-spin"></i> Loading system data...
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let charts = {};
        let historicalData = {};

        // LCARS Chart.js configuration
        const lcarsChartConfig = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        color: '#FFFFFF',
                        font: {
                            weight: 'bold'
                        }
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(26, 26, 26, 0.9)',
                    titleColor: '#FF9C00',
                    bodyColor: '#FFFFFF',
                    borderColor: '#FF9C00',
                    borderWidth: 2
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        displayFormats: {
                            hour: 'HH:mm',
                            minute: 'HH:mm',
                            second: 'HH:mm:ss'
                        }
                    },
                    title: {
                        display: true,
                        text: 'Temporal Axis',
                        color: '#FF9C00',
                        font: {
                            weight: 'bold'
                        }
                    },
                    grid: {
                        color: 'rgba(255, 156, 0, 0.2)'
                    },
                    ticks: {
                        color: '#CCCCCC'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Value',
                        color: '#FF9C00',
                        font: {
                            weight: 'bold'
                        }
                    },
                    grid: {
                        color: 'rgba(255, 156, 0, 0.2)'
                    },
                    ticks: {
                        color: '#CCCCCC'
                    }
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            }
        };

        // LCARS color palette
        const lcarsColors = {
            orange: '#FF9C00',
            red: '#CC6666',
            purple: '#CC99CC',
            blue: '#9999CC',
            yellow: '#FFFF99'
        };

        // Error handling helper function with LCARS styling
        function showChartError(canvasId, message) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.error(`Cannot show error: canvas ${canvasId} not found`);
                return;
            }

            // Hide the canvas
            canvas.style.display = 'none';

            // Find the chart container
            const container = canvas.closest('.chart-container');
            if (!container) {
                console.error(`Cannot show error: container for ${canvasId} not found`);
                return;
            }

            // Create LCARS-styled error message element
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-warning d-flex align-items-center justify-content-between';
            errorDiv.style.background = 'linear-gradient(135deg, var(--lcars-orange), var(--lcars-red))';
            errorDiv.style.border = '2px solid var(--lcars-orange)';
            errorDiv.style.borderRadius = '10px';
            errorDiv.style.color = 'var(--lcars-text)';
            errorDiv.innerHTML = `
                <div>
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span>${message}</span>
                </div>
                <button class="lcars-btn retry-chart-btn" data-canvas-id="${canvasId}">
                    <i class="fas fa-redo"></i> Retry
                </button>
            `;

            // Add to container
            container.appendChild(errorDiv);

            // Add retry button handler
            const retryBtn = errorDiv.querySelector('.retry-chart-btn');
            retryBtn.addEventListener('click', function() {
                errorDiv.remove();
                canvas.style.display = 'block';
                initializeLcarsCharts();
            });
        }

        // Initialize LCARS charts with error handling
        function initializeLcarsCharts() {
            // Voltage Chart
            try {
                const voltageCtx = document.getElementById('voltageChart');
                if (!voltageCtx) {
                    console.warn('Voltage Chart canvas not found');
                    return;
                }

                // Efficient config clone - only override what's needed
                const voltageChartConfig = {
                    ...lcarsChartConfig,
                    scales: {
                        ...lcarsChartConfig.scales,
                        y: {
                            ...lcarsChartConfig.scales.y,
                            min: 38,
                            max: 52,
                            title: {
                                ...lcarsChartConfig.scales.y.title,
                                text: 'Voltage (V)'
                            }
                        }
                    }
                };

                charts.voltage = new Chart(voltageCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        datasets: [
                            {
                                label: 'Battery Voltage (V)',
                                borderColor: lcarsColors.orange,
                                backgroundColor: 'rgba(255, 156, 0, 0.1)',
                                borderWidth: 3,
                                data: []
                            },
                            {
                                label: 'AC Output Voltage (V)',
                                borderColor: lcarsColors.red,
                                backgroundColor: 'rgba(204, 102, 102, 0.1)',
                                borderWidth: 3,
                                data: []
                            },
                            {
                                label: 'AC Input Voltage (V)',
                                borderColor: lcarsColors.purple,
                                backgroundColor: 'rgba(204, 153, 204, 0.1)',
                                borderWidth: 3,
                                data: []
                            }
                        ]
                    },
                    options: voltageChartConfig
                });
                console.log('LCARS Voltage Chart initialized successfully');
            } catch (error) {
                console.error('Failed to initialize LCARS Voltage Chart:', error);
                showChartError('voltageChart', 'Voltage chart failed to initialize');
            }

            // Power Chart
            try {
                const powerCtx = document.getElementById('powerChart');
                if (!powerCtx) {
                    console.warn('Power Chart canvas not found');
                    return;
                }

                charts.power = new Chart(powerCtx.getContext('2d'), {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'AC Output Active Power (W)',
                            borderColor: lcarsColors.blue,
                            backgroundColor: 'rgba(153, 153, 204, 0.1)',
                            borderWidth: 3,
                            data: []
                        },
                        {
                            label: 'AC Output Apparent Power (VA)',
                            borderColor: lcarsColors.yellow,
                            backgroundColor: 'rgba(255, 255, 153, 0.1)',
                            borderWidth: 3,
                            data: []
                        },
                        {
                            label: 'AC Output Load (%)',
                            borderColor: lcarsColors.orange,
                            backgroundColor: 'rgba(255, 156, 0, 0.1)',
                            borderWidth: 3,
                            data: []
                        }
                    ]
                },
                options: lcarsChartConfig
            });
                console.log('LCARS Power Chart initialized successfully');
            } catch (error) {
                console.error('Failed to initialize LCARS Power Chart:', error);
                showChartError('powerChart', 'Power chart failed to initialize');
            }

            // Temperature Chart
            try {
                const tempCtx = document.getElementById('temperatureChart');
                if (!tempCtx) {
                    console.warn('Temperature Chart canvas not found');
                    return;
                }

                charts.temperature = new Chart(tempCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        datasets: [
                            {
                                label: 'Inverter Temperature (°C)',
                                borderColor: lcarsColors.red,
                                backgroundColor: 'rgba(204, 102, 102, 0.1)',
                                borderWidth: 3,
                                data: []
                            }
                        ]
                    },
                    options: lcarsChartConfig
                });
                console.log('LCARS Temperature Chart initialized successfully');
            } catch (error) {
                console.error('Failed to initialize LCARS Temperature Chart:', error);
                showChartError('temperatureChart', 'Temperature chart failed to initialize');
            }

            // Current Chart
            try {
                const currentCtx = document.getElementById('currentChart');
                if (!currentCtx) {
                    console.warn('Current Chart canvas not found');
                    return;
                }

                charts.current = new Chart(currentCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        datasets: [
                            {
                                label: 'Battery Charging Current (A)',
                                borderColor: lcarsColors.purple,
                                backgroundColor: 'rgba(204, 153, 204, 0.1)',
                                borderWidth: 3,
                                data: []
                            },
                            {
                                label: 'Battery Discharge Current (A)',
                                borderColor: lcarsColors.blue,
                                backgroundColor: 'rgba(153, 153, 204, 0.1)',
                                borderWidth: 3,
                                data: []
                            }
                        ]
                    },
                    options: lcarsChartConfig
                });
                console.log('LCARS Current Chart initialized successfully');
            } catch (error) {
                console.error('Failed to initialize LCARS Current Chart:', error);
                showChartError('currentChart', 'Current chart failed to initialize');
            }

            // Status Chart
            try {
                const statusCtx = document.getElementById('statusChart');
                if (!statusCtx) {
                    console.warn('Status Chart canvas not found');
                    return;
                }

                charts.status = new Chart(statusCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        datasets: [
                            {
                                label: 'Is Charging On',
                                borderColor: lcarsColors.orange,
                                backgroundColor: 'rgba(255, 156, 0, 0.1)',
                                borderWidth: 3,
                                data: []
                            },
                            {
                                label: 'Is Switched On',
                                borderColor: lcarsColors.red,
                                backgroundColor: 'rgba(204, 102, 102, 0.1)',
                                borderWidth: 3,
                                data: []
                            },
                            {
                                label: 'Is Load On',
                                borderColor: lcarsColors.yellow,
                                backgroundColor: 'rgba(255, 255, 153, 0.1)',
                                borderWidth: 3,
                                data: []
                            }
                        ]
                    },
                    options: lcarsChartConfig
                });
                console.log('LCARS Status Chart initialized successfully');
            } catch (error) {
                console.error('Failed to initialize LCARS Status Chart:', error);
                showChartError('statusChart', 'Status chart failed to initialize');
            }
        }

        // Update chart data with comprehensive error handling
        function updateChartData() {
            const hours = parseInt(document.getElementById('timeRange').value);

            // Show loading state
            const dataSummaryDiv = document.getElementById('dataSummary');
            dataSummaryDiv.innerHTML = '<div class="lcars-loading"><i class="fas fa-spinner fa-spin"></i> Loading system data...</div>';

            // Use all historical data endpoint for better chart visualization
            const endpoint = hours >= 168 ? '/api/historical/all' : `/api/historical?hours=${hours}`;

            fetch(endpoint)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Validate data structure
                    if (!data || typeof data !== 'object') {
                        throw new Error('Invalid data format received from server');
                    }

                    // Check if we got sufficient data
                    const hasData = Object.keys(data).length > 0;
                    const dataPoints = hasData ? Object.values(data)[0]?.length || 0 : 0;

                    // Only fallback to all data if we have NO data at all
                    if (dataPoints === 0) {
                        console.log(`No data returned for ${hours}h filter, falling back to all data`);
                        return fetch('/api/historical/all')
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                                }
                                return response.json();
                            });
                    }

                    return data;
                })
                .then(data => {
                    if (!data || Object.keys(data).length === 0) {
                        console.warn('No historical data available');
                        dataSummaryDiv.innerHTML = `
                            <div class="alert alert-info" style="background: linear-gradient(135deg, var(--lcars-blue), var(--lcars-purple)); border: 2px solid var(--lcars-blue); color: var(--lcars-text);">
                                <i class="fas fa-info-circle me-2"></i>
                                No historical data available yet. Data will appear as the daemon collects metrics.
                            </div>
                        `;
                        return;
                    }

                    historicalData = data;
                    updateCharts();
                    updateDataSummary();
                    document.getElementById('lastUpdate').textContent = `Last update: ${new Date().toLocaleTimeString()}`;
                })
                .catch(error => {
                    console.error('Error fetching historical data:', error);

                    // Show LCARS-styled error message with retry button
                    dataSummaryDiv.innerHTML = `
                        <div class="alert alert-danger d-flex align-items-center justify-content-between" style="background: linear-gradient(135deg, var(--lcars-red), var(--lcars-orange)); border: 2px solid var(--lcars-red); color: var(--lcars-text);">
                            <div>
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Error loading data:</strong> ${error.message}
                            </div>
                            <button class="lcars-btn" onclick="updateChartData()">
                                <i class="fas fa-redo"></i> Retry
                            </button>
                        </div>
                    `;
                });
        }

        // Update individual charts with graceful degradation
        function updateCharts() {
            try {
                // Voltage Chart
                if (charts.voltage) {
                    const batteryVoltage = getChartData('mpp_solar_battery_voltage');
                    const acOutputVoltage = getChartData('mpp_solar_ac_output_voltage');
                    const acInputVoltage = getChartData('mpp_solar_ac_input_voltage');

                    charts.voltage.data.datasets[0].data = batteryVoltage;
                    charts.voltage.data.datasets[1].data = acOutputVoltage;
                    charts.voltage.data.datasets[2].data = acInputVoltage;
                    charts.voltage.update();

                    if (batteryVoltage.length === 0 && acOutputVoltage.length === 0 && acInputVoltage.length === 0) {
                        console.warn('No data available for Voltage chart');
                    }
                }

                // Power Chart
                if (charts.power) {
                    const activePower = getChartData('mpp_solar_ac_output_active_power');
                    const apparentPower = getChartData('mpp_solar_ac_output_apparent_power');
                    const load = getChartData('mpp_solar_ac_output_load');

                    charts.power.data.datasets[0].data = activePower;
                    charts.power.data.datasets[1].data = apparentPower;
                    charts.power.data.datasets[2].data = load;
                    charts.power.update();

                    if (activePower.length === 0 && apparentPower.length === 0 && load.length === 0) {
                        console.warn('No data available for Power chart');
                    }
                }

                // Temperature Chart
                if (charts.temperature) {
                    const data = getChartData('mpp_solar_inverter_heat_sink_temperature');
                    charts.temperature.data.datasets[0].data = data;
                    charts.temperature.update();
                    if (data.length === 0) {
                        console.warn('No data available for Temperature chart');
                    }
                }

                // Current Chart
                if (charts.current) {
                    const chargingCurrent = getChartData('mpp_solar_battery_charging_current');
                    const dischargeCurrent = getChartData('mpp_solar_battery_discharge_current');

                    charts.current.data.datasets[0].data = chargingCurrent;
                    charts.current.data.datasets[1].data = dischargeCurrent;
                    charts.current.update();

                    if (chargingCurrent.length === 0 && dischargeCurrent.length === 0) {
                        console.warn('No data available for Current chart');
                    }
                }

                // Status Chart
                if (charts.status) {
                    const chargingOn = getChartData('mpp_solar_is_charging_on');
                    const switchedOn = getChartData('mpp_solar_is_switched_on');
                    const loadOn = getChartData('mpp_solar_is_load_on');

                    charts.status.data.datasets[0].data = chargingOn;
                    charts.status.data.datasets[1].data = switchedOn;
                    charts.status.data.datasets[2].data = loadOn;
                    charts.status.update();

                    if (chargingOn.length === 0 && switchedOn.length === 0 && loadOn.length === 0) {
                        console.warn('No data available for Status chart');
                    }
                }
            } catch (error) {
                console.error('Error updating LCARS charts:', error);
                // Don't throw - allow charts to continue working with existing data
            }
        }

        // Get data for a specific metric
        function getChartData(metricName) {
            if (!historicalData[metricName]) return [];
            
            return historicalData[metricName].map(item => ({
                x: new Date(item.timestamp),
                y: item.value
            }));
        }

        // Update LCARS data summary
        function updateDataSummary() {
            const summaryDiv = document.getElementById('dataSummary');
            let summaryHTML = '<div class="row">';
            
            const metrics = [
                { name: 'Battery Voltage', key: 'mpp_solar_battery_voltage', unit: 'V', color: 'orange' },
                { name: 'AC Output Voltage', key: 'mpp_solar_ac_output_voltage', unit: 'V', color: 'red' },
                { name: 'Output Power', key: 'mpp_solar_ac_output_active_power', unit: 'W', color: 'blue' },
                { name: 'Temperature', key: 'mpp_solar_inverter_heat_sink_temperature', unit: '°C', color: 'purple' },
                { name: 'Load', key: 'mpp_solar_ac_output_load', unit: '%', color: 'yellow' },
                { name: 'Charging Current', key: 'mpp_solar_battery_charging_current', unit: 'A', color: 'orange' }
            ];

            metrics.forEach(metric => {
                const data = historicalData[metric.key];
                if (data && data.length > 0) {
                    const latest = data[data.length - 1];
                    const avg = data.reduce((sum, item) => sum + item.value, 0) / data.length;
                    const min = Math.min(...data.map(item => item.value));
                    const max = Math.max(...data.map(item => item.value));
                    
                    summaryHTML += `
                        <div class="col-md-4 mb-3">
                            <div class="lcars-metric-card">
                                <h6>${metric.name}</h6>
                                <div class="row">
                                    <div class="col-6">
                                        <small>Current: ${latest.value.toFixed(1)} ${metric.unit}</small><br>
                                        <small>Average: ${avg.toFixed(1)} ${metric.unit}</small>
                                    </div>
                                    <div class="col-6">
                                        <small>Min: ${min.toFixed(1)} ${metric.unit}</small><br>
                                        <small>Max: ${max.toFixed(1)} ${metric.unit}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
            
            summaryHTML += '</div>';
            summaryDiv.innerHTML = summaryHTML;
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize LCARS charts
            initializeLcarsCharts();
            
            // Load initial data
            updateChartData();
            
            // Set up refresh button
            document.getElementById('refreshCharts').addEventListener('click', updateChartData);
            
            // Set up time range selector
            document.getElementById('timeRange').addEventListener('change', updateChartData);
            
            // Set up LCARS tab switching
            const tabButtons = document.querySelectorAll('.lcars-tab-btn');
            tabButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove active class from all buttons
                    tabButtons.forEach(btn => {
                        btn.classList.remove('active');
                        btn.setAttribute('aria-selected', 'false');
                    });
                    
                    // Add active class to clicked button
                    this.classList.add('active');
                    this.setAttribute('aria-selected', 'true');
                    
                    // Hide all tab content
                    const tabContents = document.querySelectorAll('.tab-pane');
                    tabContents.forEach(content => {
                        content.classList.remove('show', 'active');
                    });
                    
                    // Show target tab content
                    const targetId = this.getAttribute('data-bs-target').substring(1);
                    const targetContent = document.getElementById(targetId);
                    if (targetContent) {
                        targetContent.classList.add('show', 'active');
                    }
                });
            });
            
            // Auto-refresh every 5 minutes
            setInterval(updateChartData, 300000);
        });
    </script>
</body>
</html>
